<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>å¾Œå°ç®¡ç†</title>
<script src="/socket.io/socket.io.js"></script>
<style>
/* æ•´é«”èƒŒæ™¯èˆ‡å­—é«” */
body {
  font-family: "Microsoft JhengHei", sans-serif;
  text-align: center;
  background: #f0f4f8;  /* å‰å°èƒŒæ™¯è‰²ç›¸åŒ */
  margin: 0;
  padding: 50px 20px; /* å¢åŠ å·¦å³ padding */
}

/* æ¨™é¡Œ */
h1 {
  font-size: 3rem;
  color: #dc2626;
  margin-bottom: 30px;
}

/* ç›®å‰è™Ÿç¢¼é¡¯ç¤º */
#number {
  font-size: 5rem;
  color: #2563eb;  /* å‰å°è™Ÿç¢¼é¡è‰² */
  margin: 20px 0;
}

/* å®¹å™¨ (RWD) */
.control-group {
  margin-bottom: 25px;
}

/* æŒ‰éˆ•æ¨£å¼ */
button {
  font-size: 1.2rem;
  padding: 10px 20px;
  margin: 10px 5px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  color: white;
  min-width: 120px; /* è®“æŒ‰éˆ•å¯¬åº¦è¼ƒä¸€è‡´ */
}
button:hover {
  opacity: 0.9;
}

#prev { background-color: #ef4444; }    /* ç´…è‰²ä¸Šä¸€è™Ÿ */
#next { background-color: #10b981; }    /* ç¶ è‰²ä¸‹ä¸€è™Ÿ */
#setNumber { background-color: #2563eb; } /* è—è‰²è¨­å®šè™Ÿç¢¼ */
#setText { background-color: #f59e0b; }   /* æ©™è‰²è¨­å®šæ–‡å­— */

/* è¼¸å…¥æ¡†èˆ‡æ–‡å­—æ¡† */
input, textarea {
  font-size: 1.2rem;
  padding: 8px;
  width: 90%; /* RWD */
  max-width: 300px; /* æœ€å¤§å¯¬åº¦ */
  text-align: center;
  border-radius: 6px;
  border: 1px solid #ccc;
  margin-top: 10px;
  box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’çˆ†å¯¬åº¦ */
}
textarea {
  resize: vertical;
  height: 80px;
  white-space: pre-wrap;   /* å…è¨±æ›è¡Œ */
  word-break: break-word;  /* éé•·æ–‡å­—è‡ªå‹•æ›è¡Œ */
}

/* é‡ç½®å€åŸŸ */
.reset-zone {
  margin-top: 40px; 
  border-top: 1px solid #ccc; 
  padding-top: 20px;
}
#resetAll {
  background-color: #7f1d1d; /* æ·±ç´…è‰² */
}
</style>
</head>
<body>

<h1>ç›®å‰è™Ÿç¢¼ï¼š<span id="number">0</span></h1>

<div class="control-group">
  <button id="prev">ä¸Šä¸€è™Ÿ</button>
  <button id="next">ä¸‹ä¸€è™Ÿ</button>
</div>

<div class="control-group">
  <input type="number" id="manualNumber" placeholder="è¼¸å…¥è™Ÿç¢¼" />
  <button id="setNumber">è¨­å®šè™Ÿç¢¼</button>
</div>

<div class="control-group">
  <textarea id="customText" placeholder="è¼¸å…¥ä¸­æ–‡æ–‡å­—ï¼Œå¯æ›è¡Œ"></textarea>
  <button id="setText">è¨­å®šæ–‡å­—</button>
</div>

<div class="reset-zone">
  <button id="resetAll">ğŸ’¥ é‡ç½®æ‰€æœ‰ (è™Ÿç¢¼/æ–‡å­—/éè™Ÿ)</button>
</div>

<script>
  const socket = io();
  const numberEl = document.getElementById("number");

  let token = localStorage.getItem("adminToken") || "";

  if (!token) {
    // ç§»é™¤äº† "é è¨­ 1234" çš„æç¤º
    token = prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼") || "";
    localStorage.setItem("adminToken", token);
  }

  // å³æ™‚æ›´æ–°è™Ÿç¢¼
  socket.on("update", num => numberEl.textContent = num);

  // çµ±ä¸€çš„ API è«‹æ±‚å‡½å¼ (åŒ…å«éŒ¯èª¤è™•ç†)
  async function apiRequest(endpoint, body) {
    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        // è‡ªå‹•å°‡ token å¤¾å¸¶åœ¨ body ä¸­
        body: JSON.stringify({ ...body, token })
      });

      // æª¢æŸ¥å›æ‡‰æ˜¯å¦ OK (status 200-299)
      if (!res.ok) {
        const errorData = await res.json();
        
        // å¦‚æœæ˜¯å¯†ç¢¼éŒ¯èª¤ (403 Forbidden)
        if (res.status === 403) {
          alert("å¯†ç¢¼éŒ¯èª¤ï¼è«‹é‡æ–°æ•´ç†é é¢ä¸¦è¼¸å…¥æ­£ç¢ºå¯†ç¢¼ã€‚");
          localStorage.removeItem("adminToken"); // æ¸…é™¤éŒ¯èª¤çš„ token
        } else {
          // é¡¯ç¤ºå¾Œç«¯å‚³ä¾†çš„å…¶ä»–éŒ¯èª¤
          alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + (errorData.error || "æœªçŸ¥éŒ¯èª¤"));
        }
        return false; // è¡¨ç¤ºè«‹æ±‚å¤±æ•—
      }
      return true; // è¡¨ç¤ºè«‹æ±‚æˆåŠŸ

    } catch (err) {
      alert("ç¶²è·¯é€£ç·šå¤±æ•—æˆ–ä¼ºæœå™¨ç„¡å›æ‡‰ï¼š" + err.message);
      return false; // è¡¨ç¤ºè«‹æ±‚å¤±æ•—
    }
  }

  // æ”¹è®Šè™Ÿç¢¼
  async function changeNumber(direction) {
    await apiRequest("/change-number", { direction });
  }

  // è¨­å®šè™Ÿç¢¼
  async function setNumber() {
    const num = document.getElementById("manualNumber").value;
    if (num === "") return; // é¿å…é€å‡ºç©ºå€¼
    
    const success = await apiRequest("/set-number", { number: num });
    if (success) {
      document.getElementById("manualNumber").value = "";
    }
  }

  // è¨­å®šæç¤ºæ–‡å­—
  async function setText() {
    const text = document.getElementById("customText").value;
    // å…è¨±é€å‡ºç©ºå­—ä¸²ä¾†æ¸…é™¤æ–‡å­—
    const success = await apiRequest("/set-text", { text });
    if (success) {
      document.getElementById("customText").value = "";
    }
  }
  
  // é‡ç½®å…¨éƒ¨
  async function resetAll() {
    if (!confirm("ç¢ºå®šè¦å°‡ç›®å‰è™Ÿç¢¼ã€æç¤ºæ–‡å­—ã€å·²å«è™Ÿç¢¼åˆ—è¡¨å…¨éƒ¨é‡ç½®å—ï¼Ÿ")) {
      return;
    }
    const success = await apiRequest("/reset", {});
    if (success) {
      document.getElementById("manualNumber").value = "";
      document.getElementById("customText").value = "";
      alert("å·²å…¨éƒ¨é‡ç½®ã€‚");
    }
  }

  // ç¶å®šæŒ‰éˆ•äº‹ä»¶
  document.getElementById("next").onclick = () => changeNumber("next");
  document.getElementById("prev").onclick = () => changeNumber("prev");
  document.getElementById("setNumber").onclick = setNumber;
  document.getElementById("setText").onclick = setText;
  document.getElementById("resetAll").onclick = resetAll;
</script>

</body>
</html>
