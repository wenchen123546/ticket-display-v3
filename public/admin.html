<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>å¾Œå°ç®¡ç†</title>
<script src="/socket.io/socket.io.js"></script>
<style>
/* æ•´é«”èƒŒæ™¯èˆ‡å­—é«” */
body {
  font-family: "Microsoft JhengHei", sans-serif;
  text-align: center;
  background: #f0f4f8; 
  margin: 0;
  padding: 50px 20px; 
}

/* æ¨™é¡Œ */
h1 {
  font-size: 3rem;
  color: #dc2626;
  margin-bottom: 30px;
}

/* ç›®å‰è™Ÿç¢¼é¡¯ç¤º */
#number {
  font-size: 5rem;
  color: #2563eb;
  margin: 20px 0;
}

/* å®¹å™¨ (RWD) */
.control-group {
  margin-bottom: 25px;
}

/* --- æ–°å¢ï¼šlabel æ¨£å¼ --- */
.control-group label {
  display: block;
  font-size: 1.1rem;
  color: #333;
  margin-bottom: 8px;
  font-weight: bold;
}

/* æŒ‰éˆ•æ¨£å¼ */
button {
  font-size: 1.2rem;
  padding: 10px 20px;
  margin: 10px 5px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  color: white;
  min-width: 120px; 
}
button:hover {
  opacity: 0.9;
}

#prev { background-color: #ef4444; } 
#next { background-color: #10b981; }
#setNumber { background-color: #2563eb; } 
#setText { background-color: #f59e0b; }
#savePassedNumbers { background-color: #0891b2; } /* --- æ–°å¢ï¼šå„²å­˜æŒ‰éˆ•é¡è‰² --- */

/* è¼¸å…¥æ¡†èˆ‡æ–‡å­—æ¡† */
input, textarea {
  font-size: 1.2rem;
  padding: 8px;
  width: 90%; 
  max-width: 300px; 
  text-align: center;
  border-radius: 6px;
  border: 1px solid #ccc;
  margin-top: 10px;
  box-sizing: border-box; 
}
textarea {
  resize: vertical;
  height: 80px;
  white-space: pre-wrap;
  word-break: break-word; 
  text-align: left; /* --- ä¿®æ”¹ï¼šè®“åˆ—è¡¨è¼¸å…¥é å·¦ --- */
  padding: 10px;    /* --- ä¿®æ”¹ï¼šå¢åŠ å…§è· --- */
}

/* é‡ç½®å€åŸŸ */
.reset-zone {
  margin-top: 40px; 
  border-top: 1px solid #ccc; 
  padding-top: 20px;
}
#resetAll {
  background-color: #7f1d1d; 
}
</style>
</head>
<body>

<h1>ç›®å‰è™Ÿç¢¼ï¼š<span id="number">0</span></h1>

<div class="control-group">
  <button id="prev">ä¸Šä¸€è™Ÿ</button>
  <button id="next">ä¸‹ä¸€è™Ÿ</button>
</div>

<div class="control-group">
  <input type="number" id="manualNumber" placeholder="è¼¸å…¥è™Ÿç¢¼" />
  <button id="setNumber">è¨­å®šè™Ÿç¢¼</button>
</div>

<div class="control-group">
  <textarea id="customText" placeholder="è¼¸å…¥ä¸­æ–‡æ–‡å­—ï¼Œå¯æ›è¡Œ"></textarea>
  <button id="setText">è¨­å®šæ–‡å­—</button>
</div>

<div class="control-group">
  <label for="passedNumbersInput">æ‰‹å‹•ç·¨è¼¯éè™Ÿåˆ—è¡¨ (ç”¨é€—è™Ÿ,åˆ†éš”)</label>
  <textarea id="passedNumbersInput" placeholder="ä¾‹å¦‚ï¼š 5, 8, 12"></textarea>
  <button id="savePassedNumbers">å„²å­˜éè™Ÿåˆ—è¡¨</button>
</div>


<div class="reset-zone">
  <button id="resetAll">ğŸ’¥ é‡ç½®æ‰€æœ‰ (è™Ÿç¢¼/æ–‡å­—/éè™Ÿ)</button>
</div>

<script>
  const socket = io();
  const numberEl = document.getElementById("number");
  
  // --- æ–°å¢ï¼šå–å¾—éè™Ÿåˆ—è¡¨çš„ textarea
  const passedNumbersInputEl = document.getElementById("passedNumbersInput");

  let token = localStorage.getItem("adminToken") || "";

  if (!token) {
    token = prompt("è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼") || "";
    localStorage.setItem("adminToken", token);
  }

  // --- Socket ç›£è½å™¨ ---

  // ç›£è½ç›®å‰è™Ÿç¢¼
  socket.on("update", num => numberEl.textContent = num);
  
  // --- æ–°å¢ï¼šç›£è½éè™Ÿåˆ—è¡¨ ---
  // ç•¶åˆ—è¡¨è¢«æ›´æ–°æ™‚ (ç„¡è«–æ˜¯èª°æ›´æ–°çš„)ï¼Œéƒ½è¦åŒæ­¥åˆ°é€™å€‹ textarea
  socket.on("updatePassed", (numbers) => {
    if (numbers && Array.isArray(numbers)) {
      // å°‡ [5, 8, 12] è½‰æˆ "5, 8, 12"
      passedNumbersInputEl.value = numbers.join(", ");
    } else {
      passedNumbersInputEl.value = "";
    }
  });


  // --- API è«‹æ±‚å‡½å¼ (ä¸è®Š) ---
  async function apiRequest(endpoint, body) {
    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...body, token })
      });

      if (!res.ok) {
        const errorData = await res.json();
        if (res.status === 403) {
          alert("å¯†ç¢¼éŒ¯èª¤ï¼è«‹é‡æ–°æ•´ç†é é¢ä¸¦è¼¸å…¥æ­£ç¢ºå¯†ç¢¼ã€‚");
          localStorage.removeItem("adminToken");
        } else {
          alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + (errorData.error || "æœªçŸ¥éŒ¯èª¤"));
        }
        return false;
      }
      return true;

    } catch (err) {
      alert("ç¶²è·¯é€£ç·šå¤±æ•—æˆ–ä¼ºæœå™¨ç„¡å›æ‡‰ï¼š" + err.message);
      return false;
    }
  }

  // --- æŒ‰éˆ•åŠŸèƒ½ ---

  // æ”¹è®Šè™Ÿç¢¼
  async function changeNumber(direction) {
    await apiRequest("/change-number", { direction });
  }

  // è¨­å®šè™Ÿç¢¼
  async function setNumber() {
    const num = document.getElementById("manualNumber").value;
    if (num === "") return;
    const success = await apiRequest("/set-number", { number: num });
    if (success) {
      document.getElementById("manualNumber").value = "";
    }
  }

  // è¨­å®šæç¤ºæ–‡å­—
  async function setText() {
    const text = document.getElementById("customText").value;
    const success = await apiRequest("/set-text", { text });
    if (success) {
      document.getElementById("customText").value = "";
    }
  }

  // --- æ–°å¢ï¼šå„²å­˜éè™Ÿåˆ—è¡¨ ---
  async function savePassedNumbers() {
    const text = passedNumbersInputEl.value; // å–å¾— "5, 8, 12"
    
    // å°‡ "5, 8, 12" æˆ– "5,8,12" è½‰æˆ [5, 8, 12]
    const numbersArray = text
      .split(',') // ç”¨é€—è™Ÿåˆ‡å‰²
      .map(n => n.trim()) // ç§»é™¤ç©ºç™½
      .filter(n => n.length > 0) // ç§»é™¤ç©ºå­—ä¸² (ä¾‹å¦‚ "5,,8" æœƒç”¢ç”Ÿç©ºå€¼)
      .map(n => Number(n)); // è½‰æˆæ•¸å­—
    
    // å‘¼å«æˆ‘å€‘åœ¨ index.js æ–°å¢çš„ API
    const success = await apiRequest("/set-passed-numbers", { numbers: numbersArray });
    
    if (success) {
      alert("éè™Ÿåˆ—è¡¨å·²å„²å­˜ã€‚");
      // (ä¸éœ€è¦æ¸…ç©ºï¼Œå› ç‚º socket.on("updatePassed") æœƒè‡ªå‹•å¾å¾Œç«¯åŒæ­¥æœ€æ–°åˆ—è¡¨)
    }
  }

  // é‡ç½®å…¨éƒ¨
  async function resetAll() {
    if (!confirm("ç¢ºå®šè¦å°‡ç›®å‰è™Ÿç¢¼ã€æç¤ºæ–‡å­—ã€å·²å«è™Ÿç¢¼åˆ—è¡¨å…¨éƒ¨é‡ç½®å—ï¼Ÿ")) {
      return;
    }
    const success = await apiRequest("/reset", {});
    if (success) {
      document.getElementById("manualNumber").value = "";
      document.getElementById("customText").value = "";
      // passedNumbersInputEl æœƒè¢« socket.on("updatePassed") è‡ªå‹•æ¸…ç©º
      alert("å·²å…¨éƒ¨é‡ç½®ã€‚");
    }
  }

  // --- ç¶å®šæŒ‰éˆ•äº‹ä»¶ ---
  document.getElementById("next").onclick = () => changeNumber("next");
  document.getElementById("prev").onclick = () => changeNumber("prev");
  document.getElementById("setNumber").onclick = setNumber;
  document.getElementById("setText").onclick = setText;
  document.getElementById("resetAll").onclick = resetAll;
  
  // --- æ–°å¢ï¼šç¶å®šå„²å­˜éè™Ÿåˆ—è¡¨æŒ‰éˆ• ---
  document.getElementById("savePassedNumbers").onclick = savePassedNumbers;
</script>

</body>
</html>
