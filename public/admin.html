<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¾Œå°ç®¡ç† - ç™»å…¥</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* (CSS ä¿æŒä¸è®Šï¼Œç‚ºæ±‚ç°¡æ½”æ­¤è™•çœç•¥) */
        body { font-family: "Microsoft JhengHei", sans-serif; text-align: center; background: #f0f4f8; margin: 0; padding: 20px; padding-top: 30px; }
        #login-container { max-width: 400px; width: 90%; box-sizing: border-box; margin: 50px auto; padding: 30px; background: #ffffff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        #login-container h1 { font-size: 2.2rem; color: #dc2626; margin-top: 0; margin-bottom: 25px; }
        #login-container input { font-size: 1.2rem; padding: 12px; width: 100%; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box; text-align: left; }
        #login-container button { font-size: 1.2rem; padding: 12px 20px; margin-top: 20px; border: none; border-radius: 8px; cursor: pointer; color: white; background-color: #2563eb; width: 100%; }
        #login-container button:hover { opacity: 0.9; }
        #login-error { color: #dc2626; margin-top: 15px; height: 1.2rem; }
        #admin-panel { display: none; padding-top: 0; max-width: 600px; margin: 0 auto; }
        #admin-panel h1 { font-size: 3rem; color: #dc2626; margin-bottom: 30px; }
        #number { font-size: 5rem; color: #2563eb; margin: 20px 0; }
        .control-group { margin-bottom: 25px; display: flex; flex-direction: column; align-items: center; flex-wrap: wrap; }
        .control-group.button-row { flex-direction: row; justify-content: center; }
        .control-group label { display: block; font-size: 1.1rem; color: #333; margin-bottom: 8px; font-weight: bold; }
        button { font-size: 1.2rem; padding: 10px 20px; margin: 10px 5px; border: none; border-radius: 8px; cursor: pointer; color: white; min-width: 120px; width: 90%; max-width: 300px; }
        .control-group.button-row button { width: auto; min-width: 120px; }
        input, textarea { font-size: 1.2rem; padding: 8px; width: 90%; max-width: 300px; text-align: center; border-radius: 6px; border: 1px solid #ccc; margin-top: 10px; box-sizing: border-box; }
        textarea { height: 80px; text-align: left; padding: 10px; }
        .reset-zone { margin-top: 40px; border-top: 1px solid #ccc; padding-top: 20px; }
        .reset-zone h3 { color: #555; font-size: 1.2rem; margin-bottom: 10px; font-weight: bold; }
        .btn-reset-single { background-color: #d97706; font-size: 1rem; padding: 8px 15px; width: auto; }
        .btn-reset-single:hover { opacity: 0.9; }
        #resetAll { background-color: #7f1d1d; margin-top: 20px; }
        @media (max-width: 768px) { body { padding: 20px 10px; } #login-container { margin: 30px auto; padding: 20px; } #admin-panel h1 { font-size: 2.2rem; } #number { font-size: 4rem; } }
        #prev { background-color: #ef4444; }
        #next { background-color: #10b981; }
        #setNumber { background-color: #2563eb; }
        #setLeftText { background-color: #f59e0b; }
        #setRightText { background-color: #f59e0b; }
        #savePassedNumbers { background-color: #0891b2; }
        #saveFeaturedContents { background-color: #8b5cf6; } 
    </style>
</head>
<body>
    <div id="login-container">
        <h1>å¾Œå°ç®¡ç†ç™»å…¥</h1>
        <input type="password" id="password-input" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼" />
        <button id="login-button" type="button">ç™»å…¥</button>
        <p id="login-error"></p>
    </div>

    <div id="admin-panel">
        <h1>ç›®å‰è™Ÿç¢¼ï¼š<span id="number">0</span></h1>

        <div class="control-group button-row">
            <button id="prev" type="button">ä¸Šä¸€è™Ÿ</button>
            <button id="next" type="button">ä¸‹ä¸€è™Ÿ</button>
        </div>
        <div class="control-group">
            <input type="number" id="manualNumber" placeholder="è¼¸å…¥è™Ÿç¢¼" />
            <button id="setNumber" type="button">è¨­å®šè™Ÿç¢¼</button>
        </div>
        <div class="control-group">
            <textarea id="leftCustomText" placeholder="è¼¸å…¥å·¦å´æ–‡å­—ï¼Œå¯æ›è¡Œ"></textarea>
            <button id="setLeftText" type="button">è¨­å®šå·¦å´æ–‡å­—</button>
        </div>
        <div class="control-group">
            <textarea id="rightCustomText" placeholder="è¼¸å…¥å³å´æ–‡å­—ï¼Œå¯æ›è¡Œ"></textarea>
            <button id="setRightText" type="button">è¨­å®šå³å´æ–‡å­—</button>
        </div>
        
        <div class="control-group">
            <label for="featuredEditorInput">ç·¨è¼¯ç²¾é¸é€£çµ (æ¯è¡Œä¸€ç­†)</label>
            <textarea id="featuredEditorInput" placeholder="æ ¼å¼ï¼š é€£çµæ–‡å­—,https://..."></textarea>
            <button id="saveFeaturedContents" type="button">å„²å­˜ç²¾é¸é€£çµ</button>
        </div>

        <div class="control-group">
            <label for="passedNumbersInput">æ‰‹å‹•ç·¨è¼¯éè™Ÿåˆ—è¡¨ (ç”¨é€—è™Ÿ,åˆ†éš”)</label>
            <textarea id="passedNumbersInput" placeholder="ä¾‹å¦‚ï¼š 5, 8, 12"></textarea>
            <button id="savePassedNumbers" type="button">å„²å­˜éè™Ÿåˆ—è¡¨</button>
        </div>

        <div class="reset-zone">
            <h3>--- é‡ç½®é¸é … ---</h3>
            <div class="control-group button-row">
                <button id="resetNumber" type="button" class="btn-reset-single">é‡ç½®è™Ÿç¢¼ (æ­¸0)</button>
                <button id="resetLeftText" type="button" class="btn-reset-single">é‡ç½®å·¦å´æ–‡å­—</button>
                <button id="resetRightText" type="button" class="btn-reset-single">é‡ç½®å³å´æ–‡å­—</button>
                <button id="resetFeaturedContents" type="button" class="btn-reset-single">é‡ç½®ç²¾é¸é€£çµ</button>
                <button id="resetPassed" type="button" class="btn-reset-single">é‡ç½®éè™Ÿåˆ—è¡¨</button>
            </div>
            <button id="resetAll" type="button">ğŸ’¥ é‡ç½®æ‰€æœ‰ (å…¨éƒ¨æ­¸0)</button>
        </div>
    </div>

    <script>
        // --- 1. å…ƒç´ ç¯€é» (DOM) ---
        const loginContainer = document.getElementById("login-container");
        const adminPanel = document.getElementById("admin-panel");
        const passwordInput = document.getElementById("password-input");
        const loginButton = document.getElementById("login-button");
        const loginError = document.getElementById("login-error");
        const numberEl = document.getElementById("number");
        const passedNumbersInputEl = document.getElementById("passedNumbersInput");
        const leftCustomTextInput = document.getElementById("leftCustomText");
        const rightCustomTextInput = document.getElementById("rightCustomText");
        const featuredEditorInput = document.getElementById("featuredEditorInput");

        // --- 2. å…¨åŸŸè®Šæ•¸ ---
        let token = "";

        // --- 3. Socket.io ---
        const socket = io({ autoConnect: false });

        // --- 4. ç™»å…¥/é¡¯ç¤ºé‚è¼¯ (ä¿æŒä¸è®Š) ---
        function showLogin() { loginContainer.style.display = "block"; adminPanel.style.display = "none"; localStorage.removeItem("adminToken"); document.title = "å¾Œå°ç®¡ç† - ç™»å…¥"; }
        function showPanel() { loginContainer.style.display = "none"; adminPanel.style.display = "block"; document.title = "å¾Œå°ç®¡ç† - æ§åˆ¶å°"; socket.connect(); }
        async function checkToken(tokenToCheck) { if (!tokenToCheck) return false; try { const res = await fetch("/check-token", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ token: tokenToCheck }), }); return res.ok; } catch (err) { console.error("checkToken å¤±æ•—:", err); return false; } }
        async function attemptLogin(tokenToCheck) { loginError.textContent = "é©—è­‰ä¸­..."; const isValid = await checkToken(tokenToCheck); if (isValid) { token = tokenToCheck; showPanel(); } else { loginError.textContent = "å¯†ç¢¼éŒ¯èª¤"; showLogin(); } }
        document.addEventListener("DOMContentLoaded", () => { showLogin(); });
        loginButton.addEventListener("click", () => { attemptLogin(passwordInput.value); });
        passwordInput.addEventListener("keyup", (event) => { if (event.key === "Enter") { attemptLogin(passwordInput.value); } });

        // --- 5. æ§åˆ¶å° Socket ç›£è½å™¨ ---
        socket.on("connect", () => { console.log("Socket.io å·²é€£æ¥"); });
        socket.on("update", (num) => (numberEl.textContent = num));
        socket.on("updatePassed", (numbers) => {
            if (numbers && Array.isArray(numbers)) { passedNumbersInputEl.value = numbers.join(", "); } else { passedNumbersInputEl.value = ""; }
        });

        // ã€ä¿®æ”¹ã€‘ ç›£è½ç²¾é¸å…§å®¹åˆ—è¡¨ (ç§»é™¤ imageUrl)
        socket.on("updateFeaturedContents", (contents) => {
            if (contents && Array.isArray(contents)) {
                // å°‡é™£åˆ— [{...}] è½‰å›æ–‡å­—ç·¨è¼¯å™¨çš„æ ¼å¼
                const textValue = contents.map(item => 
                    `${item.linkText},${item.linkUrl}` // ç§»é™¤ imageUrl
                ).join("\n");
                featuredEditorInput.value = textValue;
            } else {
                featuredEditorInput.value = "";
            }
        });

        // --- 6. API è«‹æ±‚å‡½å¼ (ä¿æŒä¸è®Š) ---
        async function apiRequest(endpoint, body) { try { const res = await fetch(endpoint, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ ...body, token }), }); if (!res.ok) { const errorData = await res.json(); if (res.status === 403) { alert("å¯†ç¢¼é©—è­‰å¤±æ•—æˆ– Token å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ã€‚"); showLogin(); } else { alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + (errorData.error || "æœªçŸ¥éŒ¯èª¤")); } return false; } return true; } catch (err) { alert("ç¶²è·¯é€£ç·šå¤±æ•—æˆ–ä¼ºæœå™¨ç„¡å›æ‡‰ï¼š" + err.message); return false; } }

        // --- 7. æ§åˆ¶å°æŒ‰éˆ•åŠŸèƒ½ ---
        async function changeNumber(direction) { await apiRequest("/change-number", { direction }); }
        async function setNumber() { const num = document.getElementById("manualNumber").value; if (num === "") return; const success = await apiRequest("/set-number", { number: num }); if (success) { document.getElementById("manualNumber").value = ""; } }
        async function setLeftText() { const text = leftCustomTextInput.value; const success = await apiRequest("/set-left-text", { text }); if (success) { leftCustomTextInput.value = ""; } }
        async function setRightText() { const text = rightCustomTextInput.value; const success = await apiRequest("/set-right-text", { text }); if (success) { rightCustomTextInput.value = ""; } }
        async function savePassedNumbers() { const text = passedNumbersInputEl.value; const numbersArray = text.split(",").map((n) => n.trim()).filter((n) => n.length > 0).map((n) => Number(n)); const success = await apiRequest("/set-passed-numbers", { numbers: numbersArray, }); if (success) { alert("éè™Ÿåˆ—è¡¨å·²å„²å­˜ã€‚"); } }

        // ã€ä¿®æ”¹ã€‘ å„²å­˜ç²¾é¸å…§å®¹ (ç§»é™¤ imageUrl)
        async function saveFeaturedContents() {
            const text = featuredEditorInput.value;
            const contentsArray = text
                .split('\n')
                .map(line => {
                    if (line.trim() === '') return null; // å¿½ç•¥ç©ºè¡Œ
                    
                    const parts = line.split(',');
                    return {
                        linkText: parts[0] ? parts[0].trim() : '',
                        linkUrl: parts[1] ? parts.slice(1).join(',').trim() : '' // è™•ç† URL ä¸­å¯èƒ½åŒ…å«é€—è™Ÿ
                    };
                })
                .filter(Boolean); // éæ¿¾æ‰ç©ºè¡Œ (null)

            const success = await apiRequest("/set-featured-contents", { contents: contentsArray });
            if (success) {
                alert("ç²¾é¸é€£çµå·²å„²å­˜ã€‚");
            }
        }

        // --- é‡ç½®åŠŸèƒ½ ---
        async function resetLeftText() { if (!confirm("ç¢ºå®šè¦æ¸…ç©ºã€Œå·¦å´æ–‡å­—ã€å—ï¼Ÿ")) return; const success = await apiRequest("/set-left-text", { text: "" }); if (success) { leftCustomTextInput.value = ""; alert("å·¦å´æ–‡å­—å·²æ¸…ç©ºã€‚"); } }
        async function resetRightText() { if (!confirm("ç¢ºå®šè¦æ¸…ç©ºã€Œå³å´æ–‡å­—ã€å—ï¼Ÿ")) return; const success = await apiRequest("/set-right-text", { text: "" }); if (success) { rightCustomTextInput.value = ""; alert("å³å´æ–‡å­—å·²æ¸…ç©ºã€‚"); } }
        async function resetNumber() { if (!confirm("ç¢ºå®šè¦å°‡ã€Œç›®å‰è™Ÿç¢¼ã€é‡ç½®ç‚º 0 å—ï¼Ÿ (æœƒå°‡ç¾æœ‰è™Ÿç¢¼åŠ å…¥éè™Ÿåˆ—è¡¨)")) return; const success = await apiRequest("/set-number", { number: 0 }); if (success) { document.getElementById("manualNumber").value = ""; alert("è™Ÿç¢¼å·²é‡ç½®ç‚º 0ã€‚"); } }
        async function resetPassed() { if (!confirm("ç¢ºå®šè¦æ¸…ç©ºã€Œå·²å«è™Ÿç¢¼(éè™Ÿ)ã€åˆ—è¡¨å—ï¼Ÿ")) return; const success = await apiRequest("/set-passed-numbers", { numbers: [] }); if (success) { alert("éè™Ÿåˆ—è¡¨å·²æ¸…ç©ºã€‚"); } }
        async function resetFeaturedContents() {
            if (!confirm("ç¢ºå®šè¦æ¸…ç©ºã€Œç²¾é¸é€£çµã€å—ï¼Ÿ")) {
                return;
            }
            const success = await apiRequest("/set-featured-contents", { contents: [] });
            if (success) {
                alert("ç²¾é¸é€£çµå·²æ¸…ç©ºã€‚");
            }
        }
        async function resetAll() {
            if (!confirm("ç¢ºå®šè¦å°‡æ‰€æœ‰å…§å®¹å…¨éƒ¨é‡ç½®å—ï¼Ÿ")) { return; }
            const success = await apiRequest("/reset", {});
            if (success) {
                document.getElementById("manualNumber").value = "";
                leftCustomTextInput.value = "";
                rightCustomTextInput.value = "";
                alert("å·²å…¨éƒ¨é‡ç½®ã€‚");
            }
        }

        // --- 8. ç¶å®šæŒ‰éˆ•äº‹ä»¶ ---
        document.getElementById("next").onclick = () => changeNumber("next");
        document.getElementById("prev").onclick = () => changeNumber("prev");
        document.getElementById("setNumber").onclick = setNumber;
        document.getElementById("savePassedNumbers").onclick = savePassedNumbers;
        document.getElementById("setLeftText").onclick = setLeftText;
        document.getElementById("setRightText").onclick = setRightText;
        document.getElementById("saveFeaturedContents").onclick = saveFeaturedContents;
        document.getElementById("resetNumber").onclick = resetNumber;
        document.getElementById("resetLeftText").onclick = resetLeftText;
        document.getElementById("resetRightText").onclick = resetRightText;
        document.getElementById("resetFeaturedContents").onclick = resetFeaturedContents;
        document.getElementById("resetPassed").onclick = resetPassed;
        document.getElementById("resetAll").onclick = resetAll;

    </script>
</body>
</html>
