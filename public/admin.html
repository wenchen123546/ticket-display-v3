<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>å¾Œå°ç®¡ç† - ç™»å…¥</title>
<script src="/socket.io/socket.io.js"></script>
<style>
/* * =================================
 * åŸºæœ¬æ¨£å¼ & ç™»å…¥ç•«é¢
 * =================================
 */
body {
  font-family: "Microsoft JhengHei", sans-serif;
  text-align: center;
  background: #f0f4f8; 
  margin: 0;
  padding: 20px; 
}

#login-container {
  max-width: 400px;
  margin: 100px auto;
  padding: 30px;
  background: #ffffff;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
#login-container h1 {
  font-size: 2.2rem;
  color: #dc2626;
  margin-top: 0;
  margin-bottom: 25px;
}
#login-container input {
  font-size: 1.2rem;
  padding: 12px;
  width: 100%;
  max-width: 100%; /* è¦†è“‹ admin-panel çš„æ¨£å¼ */
  border-radius: 6px;
  border: 1px solid #ccc;
  box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒæ’çˆ† */
  text-align: left;
}
#login-container button {
  font-size: 1.2rem;
  padding: 12px 20px;
  margin-top: 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  color: white;
  background-color: #2563eb;
  width: 100%;
}
#login-container button:hover {
  opacity: 0.9;
}
#login-error {
  color: #dc2626;
  margin-top: 15px;
  height: 1.2rem; /* ä½”ä½ç©ºé–“é¿å…è·³å‹• */
}

/* * =================================
 * å¾Œå°æ§åˆ¶å° (é è¨­éš±è—)
 * =================================
 */
#admin-panel {
  display: none; /* é—œéµï¼šé è¨­éš±è— */
  padding-top: 30px;
}

/* ( ... æ­¤è™•çš„ CSS æ¨£å¼èˆ‡ä¸Šä¸€ç‰ˆå®Œå…¨ç›¸åŒ ... ) */

/* æ¨™é¡Œ */
#admin-panel h1 {
  font-size: 3rem;
  color: #dc2626;
  margin-bottom: 30px;
}

/* ç›®å‰è™Ÿç¢¼é¡¯ç¤º */
#number {
  font-size: 5rem;
  color: #2563eb;
  margin: 20px 0;
}

/* å®¹å™¨ (RWD) */
.control-group {
  margin-bottom: 25px;
}
.control-group label {
  display: block;
  font-size: 1.1rem;
  color: #333;
  margin-bottom: 8px;
  font-weight: bold;
}

/* æŒ‰éˆ•æ¨£å¼ */
button {
  font-size: 1.2rem;
  padding: 10px 20px;
  margin: 10px 5px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  color: white;
  min-width: 120px; 
}
button:hover {
  opacity: 0.9;
}

#prev { background-color: #ef4444; } 
#next { background-color: #10b981; }
#setNumber { background-color: #2563eb; } 
#setText { background-color: #f59e0b; }
#savePassedNumbers { background-color: #0891b2; }

/* è¼¸å…¥æ¡†èˆ‡æ–‡å­—æ¡† */
input, textarea {
  font-size: 1.2rem;
  padding: 8px;
  width: 90%; 
  max-width: 300px; 
  text-align: center;
  border-radius: 6px;
  border: 1px solid #ccc;
  margin-top: 10px;
  box-sizing: border-box; 
}
textarea {
  resize: vertical;
  height: 80px;
  white-space: pre-wrap;
  word-break: break-word; 
  text-align: left;
  padding: 10px;
}

/* é‡ç½®å€åŸŸ */
.reset-zone {
  margin-top: 40px; 
  border-top: 1px solid #ccc; 
  padding-top: 20px;
}
#resetAll {
  background-color: #7f1d1d; 
}
</style>
</head>
<body>

<div id="login-container">
  <h1>å¾Œå°ç®¡ç†ç™»å…¥</h1>
  <input type="password" id="password-input" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼" />
  <button id="login-button">ç™»å…¥</button>
  <p id="login-error"></p>
</div>

<div id="admin-panel">
  <h1>ç›®å‰è™Ÿç¢¼ï¼š<span id="number">0</span></h1>
  <div class="control-group">
    <button id="prev">ä¸Šä¸€è™Ÿ</button>
    <button id="next">ä¸‹ä¸€è™Ÿ</button>
  </div>

  <div class="control-group">
    <input type="number" id="manualNumber" placeholder="è¼¸å…¥è™Ÿç¢¼" />
    <button id="setNumber">è¨­å®šè™Ÿç¢¼</button>
  </div>

  <div class="control-group">
    <textarea id="customText" placeholder="è¼¸å…¥ä¸­æ–‡æ–‡å­—ï¼Œå¯æ›è¡Œ"></textarea>
    <button id="setText">è¨­å®šæ–‡å­—</button>
  </div>

  <div class="control-group">
    <label for="passedNumbersInput">æ‰‹å‹•ç·¨è¼¯éè™Ÿåˆ—è¡¨ (ç”¨é€—è™Ÿ,åˆ†éš”)</label>
    <textarea id="passedNumbersInput" placeholder="ä¾‹å¦‚ï¼š 5, 8, 12"></textarea>
    <button id="savePassedNumbers">å„²å­˜éè™Ÿåˆ—è¡¨</button>
  </div>

  <div class="reset-zone">
    <button id="resetAll">ğŸ’¥ é‡ç½®æ‰€æœ‰ (è™Ÿç¢¼/æ–‡å­—/éè™Ÿ)</button>
  </div>
</div>


<script>
  // --- å…ƒç´ æŠ“å– (ç™»å…¥) ---
  const loginContainer = document.getElementById("login-container");
  const adminPanel = document.getElementById("admin-panel");
  const passwordInput = document.getElementById("password-input");
  const loginButton = document.getElementById("login-button");
  const loginError = document.getElementById("login-error");

  // --- å…ƒç´ æŠ“å– (æ§åˆ¶å°) ---
  const numberEl = document.getElementById("number");
  const passedNumbersInputEl = document.getElementById("passedNumbersInput");

  // --- å…¨åŸŸè®Šæ•¸ ---
  let token = ""; // ç™»å…¥æˆåŠŸå¾Œï¼Œtoken æœƒå­˜åœ¨é€™è£¡

  // --- 
  // Socket.io é è¨­ä¸è‡ªå‹•é€£ç·š
  // --- 
  const socket = io({ autoConnect: false });

  // --- 
  // é¡¯ç¤º/éš±è— çš„è¼”åŠ©å‡½å¼
  // --- 
  function showLogin() {
    loginContainer.style.display = "block";
    adminPanel.style.display = "none";
    localStorage.removeItem("adminToken"); // é¡¯ç¤ºç™»å…¥æ™‚ï¼Œæ¸…é™¤ä»»ä½•èˆŠçš„ token
    document.title = "å¾Œå°ç®¡ç† - ç™»å…¥";
  }
  
  function showPanel() {
    loginContainer.style.display = "none";
    adminPanel.style.display = "block";
    document.title = "å¾Œå°ç®¡ç† - æ§åˆ¶å°";
    
    // ç™»å…¥æˆåŠŸå¾Œï¼Œæ‰æ‰‹å‹•é€£æ¥ Socket.io
    socket.connect(); 
  }

  // --- 
  // é©—è­‰ Token çš„å‡½å¼
  // --- 
  async function checkToken(tokenToCheck) {
    if (!tokenToCheck) return false;
    try {
      const res = await fetch("/check-token", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token: tokenToCheck })
      });
      return res.ok; 
    } catch (err) {
      console.error("checkToken å¤±æ•—:", err);
      return false; 
    }
  }

  // --- 
  // æ ¸å¿ƒç™»å…¥é‚è¼¯
  // --- 
  async function attemptLogin(tokenToCheck) {
    loginError.textContent = "é©—è­‰ä¸­...";
    const isValid = await checkToken(tokenToCheck);
    
    if (isValid) {
      token = tokenToCheck; // è¨­å®šå…¨åŸŸ token
      // localStorage.setItem("adminToken", token); // <-- ã€ä¿®æ”¹ã€‘ ç§»é™¤æ­¤è¡Œï¼Œä¸å†å„²å­˜ token
      showPanel(); // é¡¯ç¤ºæ§åˆ¶å°
    } else {
      loginError.textContent = "å¯†ç¢¼éŒ¯èª¤";
      showLogin(); // é¡¯ç¤ºç™»å…¥ç•«é¢ (showLogin å·²ç¶“æœƒæ¸…é™¤ localStorage)
    }
  }
  
  // --- 
  // é é¢è¼‰å…¥æ™‚çš„æª¢æŸ¥
  // --- 
  document.addEventListener("DOMContentLoaded", () => {
    // ã€ä¿®æ”¹ã€‘ç§»é™¤è‡ªå‹•ç™»å…¥æª¢æŸ¥ï¼Œä¸€å¾‹é¡¯ç¤ºç™»å…¥ç•«é¢
    showLogin(); 
  });

  // --- 
  // ç™»å…¥æŒ‰éˆ•äº‹ä»¶
  // --- 
  loginButton.addEventListener("click", () => {
    attemptLogin(passwordInput.value);
  });
  passwordInput.addEventListener("keyup", (event) => {
    if (event.key === "Enter") {
      attemptLogin(passwordInput.value);
    }
  });


  // =============================================
  //     ä»¥ä¸‹æ˜¯æ§åˆ¶å°çš„é‚è¼¯ (åªæœ‰ç™»å…¥æˆåŠŸæ‰æœƒåŸ·è¡Œ)
  // =============================================

  // --- Socket ç›£è½å™¨ (é å…ˆå®šç¾©å¥½) ---
  socket.on("connect", () => {
    console.log("Socket.io å·²é€£æ¥");
  });
  socket.on("update", num => numberEl.textContent = num);
  socket.on("updatePassed", (numbers) => {
    if (numbers && Array.isArray(numbers)) {
      passedNumbersInputEl.value = numbers.join(", ");
    } else {
      passedNumbersInputEl.value = "";
    }
  });

  // --- 
  // çµ±ä¸€çš„ API è«‹æ±‚å‡½å¼ (ä¸è®Š)
  // --- 
  async function apiRequest(endpoint, body) {
    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...body, token }) // ä½¿ç”¨å…¨åŸŸ token
      });

      if (!res.ok) {
        const errorData = await res.json();
        
        // å¦‚æœ Token å¤±æ•ˆï¼Œè¸¢å›ç™»å…¥ç•«é¢
        if (res.status === 403) {
          alert("å¯†ç¢¼é©—è­‰å¤±æ•—æˆ– Token å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥ã€‚");
          showLogin(); // è¸¢å›ç™»å…¥
        } else {
          alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + (errorData.error || "æœªçŸ¥éŒ¯èª¤"));
        }
        return false;
      }
      return true;

    } catch (err) {
      alert("ç¶²è·¯é€£ç·šå¤±æ•—æˆ–ä¼ºæœå™¨ç„¡å›æ‡‰ï¼š" + err.message);
      return false;
    }
  }

  // --- æ§åˆ¶å°æŒ‰éˆ•åŠŸèƒ½ (èˆ‡ä¹‹å‰ç›¸åŒ) ---

  // æ”¹è®Šè™Ÿç¢¼
  async function changeNumber(direction) {
    await apiRequest("/change-number", { direction });
  }

  // è¨­å®šè™Ÿç¢¼
  async function setNumber() {
    const num = document.getElementById("manualNumber").value;
    if (num === "") return;
    const success = await apiRequest("/set-number", { number: num });
    if (success) {
      document.getElementById("manualNumber").value = "";
    }
  }

  // è¨­å®šæç¤ºæ–‡å­—
  async function setText() {
    const text = document.getElementById("customText").value;
    const success = await apiRequest("/set-text", { text });
    if (success) {
      document.getElementById("customText").value = "";
    }
  }

  // å„²å­˜éè™Ÿåˆ—è¡¨
  async function savePassedNumbers() {
    const text = passedNumbersInputEl.value;
    const numbersArray = text
      .split(',')
      .map(n => n.trim())
      .filter(n => n.length > 0)
      .map(n => Number(n));
    
    const success = await apiRequest("/set-passed-numbers", { numbers: numbersArray });
    if (success) {
      alert("éè™Ÿåˆ—è¡¨å·²å„²å­˜ã€‚");
    }
  }

  // é‡ç½®å…¨éƒ¨
  async function resetAll() {
    if (!confirm("ç¢ºå®šè¦å°‡ç›®å‰è™Ÿç¢¼ã€æç¤ºæ–‡å­—ã€å·²å«è™Ÿç¢¼åˆ—è¡¨å…¨éƒ¨é‡ç½®å—ï¼Ÿ")) {
      return;
    }
    const success = await apiRequest("/reset", {});
    if (success) {
      document.getElementById("manualNumber").value = "";
      document.getElementById("customText").value = "";
      alert("å·²å…¨éƒ¨é‡ç½®ã€‚");
    }
  }

  // --- ç¶å®šæŒ‰éˆ•äº‹ä»¶ (èˆ‡ä¹‹å‰ç›¸åŒ) ---
  document.getElementById("next").onclick = () => changeNumber("next");
  document.getElementById("prev").onclick = () => changeNumber("prev");
  document.getElementById("setNumber").onclick = setNumber;
  document.getElementById("setText").onclick = setText;
  document.getElementById("resetAll").onclick = resetAll;
  document.getElementById("savePassedNumbers").onclick = savePassedNumbers;
</script>

</body>
</html>
